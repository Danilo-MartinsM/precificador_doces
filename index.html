<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Precificador Pura Do√ßura</title>
  <style>
    :root{
      --brown:#6b3e26;
      --gold:#d4af37;
      --light-gold:#f3e9d2;
      --white:#fff;
      --muted:#fcf9f7;
    }
    body{font-family:'Inter',Arial,sans-serif;margin:0;background:var(--muted);color:#3a2b26;padding:0;}
    header{background:var(--brown);color:var(--white);padding:14px 20px;text-align:center;font-size:1.4rem;font-weight:600;letter-spacing:0.5px;}
    .wrap{max-width:1200px;margin:20px auto;display:grid;grid-template-columns:1fr 340px;gap:20px;padding:0 16px;}
    .card{background:var(--white);padding:16px 18px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.06);}
    h2,h3{margin:0 0 12px 0;color:var(--brown);font-size:1.25rem;}
    label{display:block;font-size:14px;margin:8px 0 4px;color:#5a463a;}
    input,select{padding:9px 10px;border-radius:8px;border:1px solid #e7ded8;width:100%;font-size:14px;box-sizing:border-box;}
    .btn{background:var(--brown);color:var(--white);padding:9px 14px;border-radius:8px;border:none;cursor:pointer;font-size:14px;transition:background 0.2s, transform 0.1s;}
    .btn:hover{background:#5a311c;transform:scale(1.02);}
    .small{background:#f5e9e2;border:1px solid #dec5b5;color:#543a2d;padding:6px 8px;border-radius:6px;font-size:13px;cursor:pointer;}
    .small:hover{background:#f1e1d6;}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px;}
    th,td{padding:8px 10px;border-bottom:1px dashed #eee1da;text-align:left;}
    th{background:#faf6f4;color:#5c4638;font-weight:600;}
    .inline{display:flex;gap:10px;}
    hr{border:none;border-top:1px solid #f0e6df;margin:14px 0;}
    .info{margin-top:14px;font-size:15px;color:#3a2b26;}
    .info span{font-weight:600;color:var(--brown);}
    #recipesList .card{margin-bottom:10px;}
    @media(max-width:980px){ .wrap{ grid-template-columns:1fr; } }
    @media(max-width:680px){
      header{ font-size:1.2rem; padding:12px; }
      .inline{ flex-direction:column; gap:6px; }
      input, select, .btn, .small{ font-size:15px; width:100%; }
      table{ display:block; overflow-x:auto; white-space:nowrap; font-size:13px; }
      th,td{ padding:7px; }
    }
    @media(max-width:420px){ h2{ font-size:1.1rem; } label{ font-size:12px; } }

    /* Estilo para cards de receitas */
    .recipe-card {
      background: var(--light-gold);
      border-radius: 12px;
      padding: 14px 18px;
      margin-bottom: 12px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.08);
      transition: transform 0.15s;
    }
    .recipe-card:hover {
      transform: translateY(-2px);
    }
    .recipe-card h3 {
      margin: 0 0 6px 0;
      color: var(--brown);
      font-size: 1.15rem;
    }
    .recipe-card .meta {
      font-size: 13px;
      color: #5c4638;
      margin-bottom: 8px;
    }
    .recipe-card ul {
      margin: 0;
      padding-left: 16px;
    }
    .recipe-card li {
      margin-bottom: 4px;
    }
    .recipe-card .costs {
      margin-top: 8px;
      font-weight: 600;
      color: var(--brown);
      display: flex;
      justify-content: space-between;
    }

    .recipe-card .actions {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .recipe-card .actions button {
      font-size: 13px;
      padding: 5px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    .recipe-card .actions .edit-btn {
      background: #ffd966;
      color: #5a463a;
    }

    .recipe-card .actions .edit-btn:hover {
      background: #f9d24a;
      transform: scale(1.05);
    }

    .recipe-card .actions .delete-btn {
      background: #e57373;
      color: #fff;
    }

    .recipe-card .actions .delete-btn:hover {
      background: #d64545;
      transform: scale(1.05);
    }

  </style>
</head>
<body>
  <header>üç´ Precificador Pura Do√ßura</header>

  <div class="wrap">
    <!-- Formul√°rio de nova receita -->
    <main class="card">
      <h2>Nova Receita</h2>

      <label>Categoria</label>
      <select id="categoria">
        <option>Bolos</option>
        <option>Brigadeiros</option>
        <option>Doces</option>
      </select>

      <label>Nome da Receita</label>
      <input id="nomeDoce" type="text" placeholder="Ex: Bolo de Cenoura">

      <div class="inline" style="margin-top:8px;align-items:end">
        <div style="flex:1">
          <label>Ingrediente</label>
          <select id="ingredSelect"></select>
        </div>
        <div style="flex:1">
          <label>Quantidade</label>
          <input id="qtdIng" type="number" step="any" placeholder="Ex: 200">
        </div>
        <div style="flex:1">
          <label>Unidade</label>
          <select id="unitIng">
            <option value="g">g</option>
            <option value="ml">ml</option>
            <option value="unit">unidade</option>
          </select>
        </div>
        <button class="btn" id="addIng" style="margin-bottom: 3px;">Adicionar</button>
      </div>

      <table id="tbl">
        <thead><tr><th>Ingrediente</th><th>Qtd</th><th>Unid.</th><th>Custo</th><th></th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="inline" style="margin-top:14px;align-items:center">
        <div style="flex:1">
          <label>Embalagem (R$)</label><input id="emb" type="number" step="any" value="0">
        </div>
        <div style="flex:1">
          <label>Margem (%)</label><input id="marg" type="number" step="any" value="50">
        </div>
        <div style="flex:1">
          <label>Rendimento (quantos doces)</label>
          <input id="rendimento" type="number" step="1" value="1">
        </div>

        <div>
          <button class="btn" id="btnSaveRecipe" style="margin-top: 25px;">Salvar Receita</button>
        </div>
      </div>

      <div class="info">
        <div><strong>Custo total:</strong> <span id="cost">R$ 0,00</span></div>
        <div><strong>Pre√ßo sugerido por unidade:</strong> <span id="price">R$ 0,00</span></div>
      </div>

      <hr>
      <h2>Receitas Salvas</h2>
      <div id="recipesList">Carregando...</div>
    </main>

    <!-- Painel de ingredientes -->
    <aside class="card">
      <h2>Ingredientes</h2>
      <div id="ingList">Carregando...</div>

      <hr>

      <h3>Adicionar / Editar</h3>
      <label>Nome</label><input id="formName" type="text" placeholder="Ex: A√ß√∫car refinado">
      <label>Qtd. base</label><input id="formAmount" type="number" step="any" value="100">
      <label>Unidade</label>
      <select id="formUnit"><option value="g">g</option><option value="ml">ml</option><option value="unit">unidade</option></select>
      <label>Pre√ßo p/ qtd base (R$)</label><input id="formPrice" type="number" step="any" value="1.00">
      <label>Densidade (g/ml ou g/un)</label><input id="formDensity" type="number" step="any" value="1">

      <div class="inline" style="margin-top:8px">
        <button class="btn" id="btnAddIngDb">Salvar Ingrediente</button>
        <button class="small" id="btnClearForm">Limpar</button>
      </div>

      <p style="margin-top:10px;color:#6b4b42;font-size:13px">
        Toque num item para editar ou excluir.
      </p>
    </aside>
  </div>

  <script>
    const API = "http://localhost:8000";
    let catalog = [], recipe = [];

    // =====================
    // FUN√á√ïES DE API
    // =====================
    async function fetchIngredients() {
      const res = await fetch(API + "/ingredientes");
      catalog = await res.json();
      renderCatalog();
    }

    async function fetchRecipes() {
      const res = await fetch(API + "/receitas");
      const data = await res.json();
      renderRecipesList(data);
    }

    async function saveIngredient(payload, id=null) {
      if (id) {
        await fetch(`${API}/ingredientes/${id}`, {
          method: "PUT",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload)
        });
      } else {
        await fetch(`${API}/ingredientes`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload)
        });
      }
      clearForm();
      await fetchIngredients();
    }

    async function removeIngredient(id) {
      if (!confirm("Remover ingrediente do banco?")) return;
      await fetch(`${API}/ingredientes/${id}`, { method: "DELETE" });
      await fetchIngredients();
      renderRecipeTable();
    }

    async function saveRecipe(payload, id=null) {
      let res;
      if (id) {
        res = await fetch(`${API}/receitas/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      } else {
        res = await fetch(`${API}/receitas`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      }
      return res;
    }

    async function deleteRecipeAPI(id) {
      if (!confirm("Deseja realmente excluir esta receita?")) return;
      const res = await fetch(`${API}/receitas/${id}`, { method: "DELETE" });
      return res.ok;
    }

    // =====================
    // C√ÅLCULOS
    // =====================
    function convertUnits(value, from, to, density) {
      const v = Number(value) || 0;
      if (from === to) return v;
      if (from === "ml" && to === "g") return v * (Number(density) || 1);
      if (from === "g" && to === "ml") return v / (Number(density) || 1);
      return null;
    }

    function calcCostForItem(it) {
      const item = catalog.find(c => c.id === it.ingrediente_id);
      if (!item) return 0;
      let conv;
      if (it.unidade === "unit" && item.unit === "unit") conv = it.quantidade;
      else if (it.unidade === "unit" && item.unit !== "unit") conv = it.quantidade * Number(item.amount);
      else conv = convertUnits(it.quantidade, it.unidade, item.unit, item.density);
      if (conv === null || isNaN(conv)) return 0;
      return (conv / Number(item.amount)) * Number(item.price);
    }

    function calcTotalCost() {
      let sum = 0;
      recipe.forEach(it => sum += calcCostForItem(it));
      const embV = Number(emb.value) || 0;
      const margV = Number(marg.value) || 0;
      const rend = Number(rendimento.value) || 1;
      const total = sum;
      const totalComMargem = (total + embV) * (1 + margV / 100);
      const precoUnitario = totalComMargem / rend;
      return { total, totalComMargem, precoUnitario };
    }

    // =====================
    // RENDERIZA√á√ÉO
    // =====================
    function renderCatalog() {
      const sel = document.getElementById("ingredSelect");
      sel.innerHTML = "";
      const listDiv = document.getElementById("ingList");
      listDiv.innerHTML = "";

      catalog.forEach(i => {
        // select
        const opt = document.createElement("option");
        opt.value = i.id;
        opt.textContent = i.nome;
        sel.appendChild(opt);

        // lista lateral
        const div = document.createElement("div");
        div.style.display = "flex";
        div.style.justifyContent = "space-between";
        div.style.alignItems = "center";
        div.style.marginBottom = "8px";
        div.innerHTML = `<div>${i.nome} <small style="color:#7c5c47">(${i.amount}${i.unit} ‚Üí R$ ${Number(i.price).toFixed(2)})</small></div>`;
        
        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.gap = "6px";
        const btnE = document.createElement("button");
        btnE.textContent = "Editar";
        btnE.className = "small";
        btnE.onclick = () => loadIntoForm(i);
        const btnD = document.createElement("button");
        btnD.textContent = "Excluir";
        btnD.className = "small";
        btnD.onclick = () => removeIngredient(i.id);
        right.appendChild(btnE);
        right.appendChild(btnD);
        div.appendChild(right);
        listDiv.appendChild(div);
      });
    }

    function renderRecipeTable() {
      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "";
      recipe.forEach((it, idx) => {
        const cost = calcCostForItem(it);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${it.nome}</td><td>${it.quantidade}</td><td>${it.unidade}</td><td>R$ ${Number(cost).toFixed(2)}</td><td><button class="small" data-i="${idx}">Remover</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll("button[data-i]").forEach(b => {
        b.addEventListener("click", e => {
          const i = Number(e.target.dataset.i);
          recipe.splice(i, 1);
          renderRecipeTable();
        });
      });

      const costs = calcTotalCost();
      cost.textContent = "R$ " + (costs.total + (Number(emb.value)||0)).toFixed(2);
      price.textContent = "R$ " + costs.precoUnitario.toFixed(2);
    }

    function renderRecipesList(data) {
      const div = document.getElementById("recipesList");
      div.innerHTML = "";
      if (data.length === 0) { div.textContent = "Nenhuma receita cadastrada"; return; }

      data.forEach(r => {
        const card = document.createElement("div");
        card.className = "recipe-card";

        let html = `<h3>${r.nome}</h3>
                    <div class="meta">Categoria: ${r.categoria || "Sem categoria"} | Rendimento: ${r.rendimento || 1} doces</div>
                    <div class="costs">
                      <span>Custo total: R$ ${Number(r.custo_total).toFixed(2)}</span>
                      <span>Pre√ßo/unidade: R$ ${(Number(r.preco_por_unidade)).toFixed(2)}</span>
                    </div>
                    <strong>Ingredientes:</strong>
                    <ul>`;
        r.itens.forEach(i => html += `<li>${i.quantidade} ${i.unidade} de ${i.nome}</li>`);
        html += "</ul>";
        html += `<div class="actions">
                    <button class="edit-btn">Editar</button>
                    <button class="delete-btn">Excluir</button>
                </div>`;
        card.innerHTML = html;
        div.appendChild(card);

        const [editBtn, deleteBtn] = card.querySelectorAll(".actions button");
        editBtn.addEventListener("click", () => editRecipe(r));
        deleteBtn.addEventListener("click", async () => {
          if(await deleteRecipeAPI(r.id)) fetchRecipes();
        });
      });
    }

    // =====================
    // FORMUL√ÅRIOS
    // =====================
    function loadIntoForm(i) {
      formName.value = i.nome;
      formAmount.value = i.amount;
      formUnit.value = i.unit;
      formPrice.value = i.price;
      formDensity.value = i.density;
      btnAddIngDb.dataset.editing = i.id;
      btnAddIngDb.textContent = "Atualizar";
    }

    function clearForm() {
      formName.value = "";
      formAmount.value = 100;
      formUnit.value = "g";
      formPrice.value = 1;
      formDensity.value = 1;
      delete btnAddIngDb.dataset.editing;
      btnAddIngDb.textContent = "Salvar Ingrediente";
    }

    // =====================
    // EVENTOS
    // =====================
    btnClearForm.addEventListener("click", clearForm);

    btnAddIngDb.addEventListener("click", async () => {
      const payload = {
        nome: formName.value.trim(),
        amount: Number(formAmount.value) || 100,
        unit: formUnit.value,
        price: Number(formPrice.value) || 0,
        density: Number(formDensity.value) || 1
      };
      if (!payload.nome) { alert("Nome √© obrigat√≥rio"); return; }
      await saveIngredient(payload, btnAddIngDb.dataset.editing);
    });

    addIng.addEventListener("click", () => {
      const sel = document.getElementById("ingredSelect");
      const id = Number(sel.value);
      const q = Number(qtdIng.value) || 0;
      const unit = unitIng.value;
      if (!id) { alert("Escolha um ingrediente"); return; }
      if (q <= 0 && unit !== "unit") { alert("Quantidade inv√°lida"); return; }
      const item = catalog.find(c => c.id === id);
      recipe.push({ ingrediente_id: id, quantidade: q, unidade: unit, nome: item.nome });
      qtdIng.value = "";
      renderRecipeTable();
    });

    // SALVAR / ATUALIZAR RECEITA
    btnSaveRecipe.addEventListener("click", async () => {
      const nome = nomeDoce.value.trim();
      const categoriaValue = document.getElementById("categoria").value;
      const embV = Number(emb.value) || 0;
      const margV = Number(marg.value) || 50;
      const rend = Number(rendimento.value) || 1;

      if (!nome) { alert("Informe o nome da receita"); return; }
      if (recipe.length === 0) { alert("Adicione ingredientes"); return; }

      const payload = {
        nome,
        categoria: categoriaValue,
        embalagem: embV,
        margem: margV,
        rendimento: rend,
        ingredientes: recipe.map(r => ({ ingrediente_id: r.ingrediente_id, quantidade: r.quantidade, unidade: r.unidade }))
      };

      const editing = btnSaveRecipe.dataset.editing;
      const res = await saveRecipe(payload, editing);
      if (res.ok) {
        alert("Receita salva com sucesso!");
        nomeDoce.value = "";
        recipe = [];
        renderRecipeTable();
        delete btnSaveRecipe.dataset.editing;
        btnSaveRecipe.textContent = "Salvar Receita";
        fetchRecipes();
      } else {
        const err = await res.json();
        alert("Erro: " + (err.detail || "verifique o console"));
        console.error(err);
      }
    });

    // EDITAR RECEITA
    function editRecipe(r) {
      nomeDoce.value = r.nome;
      document.getElementById("categoria").value = r.categoria || "Bolos";
      emb.value = r.embalagem;
      marg.value = r.margem;
      rendimento.value = r.rendimento;

      recipe = r.itens.map(i => ({
        ingrediente_id: i.ingrediente_id,
        quantidade: i.quantidade,
        unidade: i.unidade,
        nome: i.nome
      }));
      renderRecipeTable();

      btnSaveRecipe.textContent = "Atualizar Receita";
      btnSaveRecipe.dataset.editing = r.id;
    }

    // INPUTS DIN√ÇMICOS
    emb.addEventListener("input", renderRecipeTable);
    marg.addEventListener("input", renderRecipeTable);
    rendimento.addEventListener("input", renderRecipeTable);

    // =====================
    // INICIALIZA√á√ÉO
    // =====================
    fetchIngredients();
    fetchRecipes();
    </script>


</body>
</html>
