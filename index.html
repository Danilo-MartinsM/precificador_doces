<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Precificador Pura Do√ßura</title>
  <style>
    :root{
      --brown:#6b3e26;
      --gold:#d4af37;
      --light-gold:#f3e9d2;
      --white:#fff;
      --muted:#fcf9f7;
    }

    body{
      font-family: 'Inter', Arial, sans-serif;
      margin:0;
      background:var(--muted);
      color:#3a2b26;
      padding:0;
    }

    header{
      background:var(--brown);
      color:var(--white);
      padding:14px 20px;
      text-align:center;
      font-size:1.4rem;
      font-weight:600;
      letter-spacing:0.5px;
    }

    .wrap{
      max-width:1200px;
      margin:20px auto;
      display:grid;
      grid-template-columns:1fr 340px;
      gap:20px;
      padding:0 16px;
    }

    .card{
      background:var(--white);
      padding:16px 18px;
      border-radius:12px;
      box-shadow:0 4px 16px rgba(0,0,0,0.06);
    }

    h2, h3{
      margin:0 0 12px 0;
      color:var(--brown);
      font-size:1.25rem;
    }

    label{
      display:block;
      font-size:14px;
      margin:8px 0 4px;
      color:#5a463a;
    }

    input,select{
      padding:9px 10px;
      border-radius:8px;
      border:1px solid #e7ded8;
      width:100%;
      font-size:14px;
      box-sizing:border-box;
    }

    .btn{
      background:var(--brown);
      color:var(--white);
      padding:9px 14px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-size:14px;
      transition:background 0.2s, transform 0.1s;
    }

    .btn:hover{
      background:#5a311c;
      transform:scale(1.02);
    }

    .small{
      background:#f5e9e2;
      border:1px solid #dec5b5;
      color:#543a2d;
      padding:6px 8px;
      border-radius:6px;
      font-size:13px;
      cursor:pointer;
    }

    .small:hover{ background:#f1e1d6; }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:14px;
    }

    th,td{
      padding:8px 10px;
      border-bottom:1px dashed #eee1da;
      text-align:left;
    }

    th{
      background:#faf6f4;
      color:#5c4638;
      font-weight:600;
    }

    .inline{
      display:flex;
      gap:10px;
    }

    hr{
      border:none;
      border-top:1px solid #f0e6df;
      margin:14px 0;
    }

    .info{
      margin-top:14px;
      font-size:15px;
      color:#3a2b26;
    }

    .info span{
      font-weight:600;
      color:var(--brown);
    }

    @media(max-width:980px){ .wrap{ grid-template-columns:1fr; } }
    @media(max-width:680px){
      header{ font-size:1.2rem; padding:12px; }
      .inline{ flex-direction:column; gap:6px; }
      input, select, .btn, .small{ font-size:15px; width:100%; }
      table{ display:block; overflow-x:auto; white-space:nowrap; font-size:13px; }
      th,td{ padding:7px; }
    }
    @media(max-width:420px){ h2{ font-size:1.1rem; } label{ font-size:12px; } }
  </style>
</head>
<body>
  <header>üç´ Precificador Pura Do√ßura</header>

  <div class="wrap">
    <main class="card">
      <h2>Nova Receita</h2>

      <label>Categoria</label>
      <select id="categoria">
        <option>Bolos</option>
        <option>Brigadeiros</option>
        <option>Doces</option>
      </select>

      <label>Nome da Receita</label>
      <input id="nomeDoce" type="text" placeholder="Ex: Bolo de Cenoura">

      <div class="inline" style="margin-top:8px;align-items:end">
        <div style="flex:1">
          <label>Ingrediente</label>
          <select id="ingredSelect"></select>
        </div>
        <div style="flex:1">
          <label>Quantidade</label>
          <input id="qtdIng" type="number" step="any" placeholder="Ex: 200">
        </div>
        <div style="flex:1">
          <label>Unidade</label>
          <select id="unitIng">
            <option value="g">g</option>
            <option value="ml">ml</option>
            <option value="unit">unidade</option>
          </select>
        </div>
        <button class="btn" id="addIng">Adicionar</button>
      </div>

      <table id="tbl">
        <thead><tr><th>Ingrediente</th><th>Qtd</th><th>Unid.</th><th>Custo</th><th></th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="inline" style="margin-top:14px;align-items:center">
        <div style="flex:1">
          <label>Embalagem (R$)</label><input id="emb" type="number" step="any" value="0">
        </div>
        <div style="flex:1">
          <label>Margem (%)</label><input id="marg" type="number" step="any" value="50">
        </div>
        <div>
          <button class="btn" id="btnSaveRecipe">Salvar Receita</button>
        </div>
      </div>

      <div class="info">
        <div><strong>Custo total:</strong> <span id="cost">R$ 0,00</span></div>
        <div><strong>Pre√ßo sugerido:</strong> <span id="price">R$ 0,00</span></div>
      </div>
    </main>

    <aside class="card">
      <h2>Ingredientes</h2>
      <div id="ingList">Carregando...</div>

      <hr>

      <h3>Adicionar / Editar</h3>
      <label>Nome</label><input id="formName" type="text" placeholder="Ex: A√ß√∫car refinado">
      <label>Qtd. base</label><input id="formAmount" type="number" step="any" value="100">
      <label>Unidade</label>
      <select id="formUnit"><option value="g">g</option><option value="ml">ml</option><option value="unit">unidade</option></select>
      <label>Pre√ßo p/ qtd base (R$)</label><input id="formPrice" type="number" step="any" value="1.00">
      <label>Densidade (g/ml ou g/un)</label><input id="formDensity" type="number" step="any" value="1">

      <div class="inline" style="margin-top:8px">
        <button class="btn" id="btnAddIngDb">Salvar Ingrediente</button>
        <button class="small" id="btnClearForm">Limpar</button>
      </div>

      <p style="margin-top:10px;color:#6b4b42;font-size:13px">
        Toque num item para editar ou excluir.
      </p>
    </aside>
  </div>

  <script>
    const API = "http://localhost:8000";
    let catalog = [], recipe = [];

    async function loadIngredients(){
      const res = await fetch(API + "/ingredientes");
      catalog = await res.json();
      renderCatalog();
    }

    function renderCatalog(){
      const sel = document.getElementById("ingredSelect");
      sel.innerHTML = "";
      const listDiv = document.getElementById("ingList");
      listDiv.innerHTML = "";
      catalog.forEach(i=>{
        const opt=document.createElement("option");
        opt.value=i.id; opt.textContent=i.nome;
        sel.appendChild(opt);

        const div=document.createElement("div");
        div.style.display="flex";
        div.style.justifyContent="space-between";
        div.style.alignItems="center";
        div.style.marginBottom="8px";
        div.innerHTML=`<div>${i.nome} <small style="color:#7c5c47">(${i.amount}${i.unit} ‚Üí R$ ${Number(i.price).toFixed(2)})</small></div>`;

        const right=document.createElement("div");
        right.style.display="flex"; right.style.gap="6px";
        const btnE=document.createElement("button");
        btnE.textContent="Editar"; btnE.className="small";
        btnE.onclick=()=>loadIntoForm(i);
        const btnD=document.createElement("button");
        btnD.textContent="Excluir"; btnD.className="small";
        btnD.onclick=()=>removeIngredient(i.id);
        right.appendChild(btnE); right.appendChild(btnD);
        div.appendChild(right);
        listDiv.appendChild(div);
      });
    }

    function loadIntoForm(i){
      formName.value=i.nome;
      formAmount.value=i.amount;
      formUnit.value=i.unit;
      formPrice.value=i.price;
      formDensity.value=i.density;
      btnAddIngDb.dataset.editing=i.id;
      btnAddIngDb.textContent="Atualizar";
    }

    btnClearForm.addEventListener("click", ()=>clearForm());
    function clearForm(){
      formName.value=""; formAmount.value=100; formUnit.value="g"; formPrice.value=1.00; formDensity.value=1;
      delete btnAddIngDb.dataset.editing;
      btnAddIngDb.textContent="Salvar Ingrediente";
    }

    async function removeIngredient(id){
      if(!confirm("Remover ingrediente do banco?")) return;
      await fetch(API+"/ingredientes/"+id,{method:"DELETE"});
      await loadIngredients(); renderRecipeTable();
    }

    btnAddIngDb.addEventListener("click", async ()=>{
      const name=formName.value.trim();
      const amount=Number(formAmount.value)||100;
      const unit=formUnit.value;
      const price=Number(formPrice.value)||0;
      const density=Number(formDensity.value)||1;
      if(!name){alert("Nome √© obrigat√≥rio");return;}
      const payload={nome:name,unit,amount,price,density};
      const editing=btnAddIngDb.dataset.editing;
      if(editing){
        await fetch(API+"/ingredientes/"+editing,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      } else {
        await fetch(API+"/ingredientes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      }
      clearForm(); await loadIngredients();
    });

    addIng.addEventListener("click", ()=>{
      const sel=document.getElementById("ingredSelect");
      const id=Number(sel.value);
      const q=Number(qtdIng.value)||0;
      const unit=unitIng.value;
      if(!id){alert("Escolha um ingrediente");return;}
      if(q<=0&&unit!=="unit"){alert("Quantidade inv√°lida");return;}
      const item=catalog.find(c=>c.id===id);
      recipe.push({ingrediente_id:id,quantidade:q,unidade:unit,nome:item.nome});
      qtdIng.value=""; renderRecipeTable();
    });

    // ======= Fun√ß√£o corrigida =======
    function calcCostForItem(it){
      const item = catalog.find(c => c.id === it.ingrediente_id);
      if(!item) return 0;

      if(item.unit === "unit") {
        return Number(item.price) * Number(it.quantidade); // 1 unidade = pre√ßo total
      }

      const conv = convertUnits(it.quantidade, it.unidade, item.unit, item.density);
      if(conv === null || isNaN(conv)) return 0;

      return (conv / Number(item.amount)) * Number(item.price);
    }

    function convertUnits(value,from,to,density){
      const v=Number(value)||0;
      if(from===to)return v;
      if(from==="unit"||to==="unit"){
        if(from==="unit"&&to!=="unit"){
          const grams=v*Number(density);
          if(to==="g")return grams;
          if(to==="ml")return grams/(Number(density)||1);
        }
        if(to==="unit"&&from!=="unit"){
          let grams=(from==="g")?v:(from==="ml"?v*Number(density):NaN);
          return grams/(Number(density)||1);
        }
        return null;
      }
      if(from==="ml"&&to==="g")return v*(Number(density)||1);
      if(from==="g"&&to==="ml")return v/(Number(density)||1);
      return null;
    }

    function renderRecipeTable(){
      const tbody=document.querySelector("#tbl tbody");
      tbody.innerHTML="";
      let sum=0;
      recipe.forEach((it,idx)=>{
        const tr=document.createElement("tr");
        const cost=calcCostForItem(it);
        sum+=cost;
        tr.innerHTML=`<td>${it.nome}</td><td>${it.quantidade}</td><td>${it.unidade}</td><td>R$ ${Number(cost).toFixed(2)}</td><td><button class="small" data-i="${idx}">Remover</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll("button[data-i]").forEach(b=>{
        b.addEventListener("click",(e)=>{
          const i=Number(e.target.dataset.i);
          recipe.splice(i,1);
          renderRecipeTable();
        });
      });
      const embV=Number(emb.value)||0;
      const margV=Number(marg.value)||0;
      const total=sum+embV;
      const suggested=total*(1+margV/100);
      cost.textContent="R$ "+total.toFixed(2);
      price.textContent="R$ "+suggested.toFixed(2);
    }

    btnSaveRecipe.addEventListener("click", async ()=>{
      const nome=nomeDoce.value.trim();
      const categoria=categoria.value;
      const embV=Number(emb.value)||0;
      const margV=Number(marg.value)||50;
      if(!nome){alert("Informe o nome da receita");return;}
      if(recipe.length===0){alert("Adicione ingredientes");return;}
      const payload={nome,categoria,embalagem:embV,margem:margV,ingredientes:recipe.map(r=>({ingrediente_id:r.ingrediente_id,quantidade:r.quantidade,unidade:r.unidade}))};
      const res=await fetch(API+"/receitas",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      if(res.ok){
        alert("Receita salva com sucesso!");
        nomeDoce.value=""; recipe=[]; renderRecipeTable();
      } else {
        const err=await res.json();
        alert("Erro: "+(err.detail||"verifique o console"));
        console.error(err);
      }
    });

    loadIngredients();
    emb.addEventListener("input",renderRecipeTable);
    marg.addEventListener("input",renderRecipeTable);
  </script>
</body>
</html>
